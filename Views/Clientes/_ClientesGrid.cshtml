@using AutoGestao.Enumerador
@using AutoGestao.Extensions
@using AutoGestao.Models
@model ClientesIndexViewModel

<div class="table-responsive">
    <table class="table table-hover mb-0 clientes-grid base-grid-table" id="clientesTable">
        <thead class="table-dark sticky-top">
            <tr>
                <th style="cursor: pointer;" onclick="sortColumn('Nome')">
                    <div class="d-flex align-items-center">
                        Cliente
                        <i class="fas fa-sort ms-1 @(Model.OrderBy == "Nome" ? (Model.OrderDirection == "asc" ? "fa-sort-up" : "fa-sort-down") : "")"></i>
                    </div>
                </th>
                <th style="cursor: pointer;" onclick="sortColumn('Tipo')">
                    <div class="d-flex align-items-center">
                        Tipo
                        <i class="fas fa-sort ms-1 @(Model.OrderBy == "Tipo" ? (Model.OrderDirection == "asc" ? "fa-sort-up" : "fa-sort-down") : "")"></i>
                    </div>
                </th>
                <th style="cursor: pointer;" onclick="sortColumn('Documento')">
                    <div class="d-flex align-items-center">
                        Documento
                        <i class="fas fa-sort ms-1 @(Model.OrderBy == "Documento" ? (Model.OrderDirection == "asc" ? "fa-sort-up" : "fa-sort-down") : "")"></i>
                    </div>
                </th>
                <th>Contato</th>
                <th style="cursor: pointer;" onclick="sortColumn('Cidade')">
                    <div class="d-flex align-items-center">
                        Localização
                        <i class="fas fa-sort ms-1 @(Model.OrderBy == "Cidade" ? (Model.OrderDirection == "asc" ? "fa-sort-up" : "fa-sort-down") : "")"></i>
                    </div>
                </th>
                <th>Status</th>
                <th style="cursor: pointer;" onclick="sortColumn('DataCadastro')">
                    <div class="d-flex align-items-center">
                        Cadastro
                        <i class="fas fa-sort ms-1 @(Model.OrderBy == "DataCadastro" ? (Model.OrderDirection == "asc" ? "fa-sort-up" : "fa-sort-down") : "")"></i>
                    </div>
                </th>
                <th>⚙️</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.ListaObjeto != null && Model.ListaObjeto.Any())
            {
                @foreach (var cliente in Model.ListaObjeto)
                {
                    <tr class="cliente-row grid-row">
                        <!-- COLUNA 1: CLIENTE -->
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="cliente-avatar me-2">
                                    @if (cliente.TipoCliente == EnumTipoPessoa.PessoaFisica)
                                    {
                                        <i class="fas fa-user text-primary"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-building text-warning"></i>
                                    }
                                </div>
                                <div>
                                    <div class="fw-semibold" style="font-size: 0.85rem;">@cliente.Nome</div>
                                    @if (!string.IsNullOrEmpty(cliente.Email))
                                    {
                                        <small class="text-muted" style="font-size: 0.75rem;">@cliente.Email</small>
                                    }
                                </div>
                            </div>
                        </td>

                        <!-- COLUNA 2: TIPO -->
                        <td>
                            @if (cliente.TipoCliente == EnumTipoPessoa.PessoaFisica)
                            {
                                <span class="badge badge-compact bg-primary">
                                    <i class="fas fa-user"></i>
                                </span>
                            }
                            else
                            {
                                <span class="badge badge-compact bg-warning text-dark">
                                    <i class="fas fa-building"></i>
                                </span>
                            }
                        </td>

                        <!-- COLUNA 3: DOCUMENTO -->
                        <td>
                            <div class="documento-info">
                                <div class="fw-semibold" style="font-size: 0.8rem;">
                                    @if (!string.IsNullOrEmpty(cliente.CPF))
                                    {
                                        @cliente.CPF
                                        <br>
                            
                                        <small class="text-muted">CPF: @cliente.RG</small>
                                    }
                                    else if (!string.IsNullOrEmpty(cliente.CNPJ))
                                    {
                                        @cliente.CNPJ
                                        <br>
                            
                                        <small class="text-muted">CNPJ</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </div>
                            </div>
                        </td>

                        <!-- COLUNA 4: CONTATO -->
                        <td>
                            <div class="contato-info">
                                @if (!string.IsNullOrEmpty(cliente.Telefone))
                                {
                                    <div style="font-size: 0.8rem;">
                                        <i class="fas fa-phone text-success"></i> @cliente.Telefone
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(cliente.Celular))
                                {
                                    <div style="font-size: 0.8rem;">
                                        <i class="fas fa-mobile text-info"></i> @cliente.Celular
                                    </div>
                                }
                                @if (string.IsNullOrEmpty(cliente.Telefone) && string.IsNullOrEmpty(cliente.Celular))
                                {
                                    <span class="text-muted">-</span>
                                }
                            </div>
                        </td>

                        <!-- COLUNA 5: LOCALIZAÇÃO -->
                        <td>
                            <div class="localizacao-info">
                                @if (!string.IsNullOrEmpty(cliente.Cidade))
                                {
                                    <div style="font-size: 0.8rem;">@cliente.Cidade</div>
                                    @if (cliente.Estado != EnumEstado.Nenhum)
                                    {
                                        <small class="text-muted">@cliente.Estado.GetDescription()</small>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </div>
                        </td>

                        <!-- COLUNA 6: STATUS -->
                        <td>
                            @if (cliente.Ativo)
                            {
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i>
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-danger">
                                    <i class="fas fa-times"></i>
                                </span>
                            }
                        </td>

                        <!-- COLUNA 7: CADASTRO -->
                        <td>
                            <div class="data-cadastro">
                                <small style="font-size: 0.75rem;">
                                    @cliente.DataCadastro.ToString("dd/MM/yyyy")
                                </small>
                            </div>
                        </td>

                        <!-- COLUNA 8: AÇÕES - SOLUÇÃO HÍBRIDA RESPONSIVA -->
                        <td>
                            <!-- DESKTOP: Dropdown com position static -->
                            <div class="dropdown position-static dropdown-desktop-only">
                                <button class="btn btn-sm btn-outline-secondary actions-btn"
                                        type="button"
                                        id="dropdownMenuButton@(cliente.Id)"
                                        data-bs-toggle="dropdown"
                                        data-bs-display="static"
                                        aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end"
                                    aria-labelledby="dropdownMenuButton@(cliente.Id)">
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Details", "Clientes", new { id = cliente.Id })">
                                            <i class="fas fa-eye text-info me-2"></i>
                                            Detalhes
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Edit", "Clientes", new { id = cliente.Id })">
                                            <i class="fas fa-edit text-warning me-2"></i>
                                            Editar
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <button class="dropdown-item text-danger" href="@Url.Action("Delete", "Clientes", new { id = cliente.Id })">
                                            <i class="fas fa-trash-alt me-2"></i>
                                            Deletar
                                        </button>
                                    </li>
                                </ul>
                            </div>

                            <!-- MOBILE: Modal trigger -->
                            <button class="btn btn-sm btn-outline-secondary mobile-action-trigger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#mobileActionModal@(cliente.Id)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="empty-state">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhum cliente encontrado</h5>
                            <p class="text-muted">Tente ajustar os filtros ou cadastre um novo cliente.</p>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (Model.TotalRecords > 0)
{
    <div class="mt-2 text-muted text-center" style="font-size: 0.85rem;">
        Exibindo @((Model.CurrentPage - 1) * Model.PageSize + 1) a @(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalRecords)) de @Model.TotalRecords registros
    </div>
}

<!-- MODALS PARA AÇÕES EM MOBILE -->
@if (Model.ListaObjeto != null && Model.ListaObjeto.Any())
{
    @foreach (var cliente in Model.ListaObjeto)
    {
        <div class="modal fade mobile-modal-only" id="mobileActionModal@(cliente.Id)" tabindex="-1">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header py-2">
                        <h6 class="modal-title">Ações - @cliente.Nome</h6>
                        <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-2">
                        <div class="d-grid gap-2">
                            <a href="@Url.Action("Details", "Clientes", new { id = cliente.Id })"
                               class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye me-2"></i> Detalhes
                            </a>
                            <a href="@Url.Action("Edit", "Clientes", new { id = cliente.Id })"
                               class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-edit me-2"></i> Editar
                            </a>
                            <button class="btn btn-sm btn-outline-success"
                                    onclick="novaVenda(@cliente.Id); bootstrap.Modal.getInstance(document.getElementById('mobileActionModal@(cliente.Id)')).hide();">
                                <i class="fas fa-shopping-cart me-2"></i> Nova Venda
                            </button>
                            <button class="btn btn-sm btn-outline-primary"
                                    onclick="novaAvaliacao(@cliente.Id); bootstrap.Modal.getInstance(document.getElementById('mobileActionModal@(cliente.Id)')).hide();">
                                <i class="fas fa-star me-2"></i> Avaliação
                            </button>
                            <hr class="my-2">
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="confirmarExclusao(@cliente.Id); bootstrap.Modal.getInstance(document.getElementById('mobileActionModal@(cliente.Id)')).hide();">
                                <i class="fas fa-trash-alt me-2"></i> Inativar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}

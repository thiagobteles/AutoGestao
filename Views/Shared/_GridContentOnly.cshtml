@model StandardGridViewModel
@using AutoGestao.Enumerador.Gerais
@using AutoGestao.Models
@using AutoGestao.Models.Grid

<!-- Search Filters -->
@if (Model.Filters?.Any() == true)
{
    <div class="search-filters">
        <form method="get" id="filtrosForm">
            <div class="row g-1">
                @foreach (var filter in Model.Filters)
                {
                    var xClasse = "col-md-4";
                    if (Model.Filters.Count == 1)
                    {
                        xClasse = "col-md-10";
                    }
                    else if (Model.Filters.Count == 2)
                    {
                        xClasse = "col-md-5";
                    }
                    else if (Model.Filters.Count == 3)
                    {
                        xClasse = "col-md-3";
                    }

                    <div class="@xClasse">
                        @if (filter.Type == EnumGridFilterType.Text)
                        {
                            <input type="text" name="@filter.Name" value="@filter.Value"
                                   class="form-control" placeholder="@filter.Placeholder" />
                        }
                        else if (filter.Type == EnumGridFilterType.Select)
                        {
                            <select name="@filter.Name" class="form-select enum-select">
                                <option value="">@filter.Placeholder</option>
                                @if (filter.Options != null)
                                {
                                    foreach (var option in filter.Options)
                                    {
                                        <option value="@option.Value" selected="@(option.Value == filter.Value?.ToString())">
                                            @option.Text
                                        </option>
                                    }
                                }
                            </select>
                        }
                        else if (filter.Type == EnumGridFilterType.Date)
                        {
                            <input type="date" name="@filter.Name" value="@filter.Value"
                                   class="form-control" placeholder="@filter.Placeholder" />
                        }
                        else if (filter.Type == EnumGridFilterType.DateRange)
                        {
                            <div class="d-flex gap-2">
                                <input type="date" name="@(filter.Name)_inicio"
                                       value="@ViewBag.GetType().GetProperty($"{filter.Name}_inicio")?.GetValue(ViewBag)"
                                       class="form-control" placeholder="Data início" />
                                <input type="date" name="@(filter.Name)_fim"
                                       value="@ViewBag.GetType().GetProperty($"{filter.Name}_fim")?.GetValue(ViewBag)"
                                       class="form-control" placeholder="Data fim" />
                            </div>
                        }
                        else if (filter.Type == EnumGridFilterType.Number)
                        {
                            <input type="number" name="@filter.Name" value="@filter.Value"
                                   class="form-control" placeholder="@filter.Placeholder" />
                        }
                    </div>
                }
                <div class="col-md-1">
                    <button type="submit" class="btn-search">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
        </form>
    </div>
}

<!-- Data Grid -->
<div class="data-grid">
    <div class="table-responsive-enhanced" id="tableContainer">
        <table class="base-grid-table">
            <thead>
                <tr>
                    @foreach (var column in Model.Columns)
                    {
                        <th width="@column.Width" class="@column.CssClass">
                            @if (column.Sortable && column.Type != EnumGridColumnType.Actions)
                            {
                                <div class="sortable-header" data-sortable="@column.Name" role="button" tabindex="0">
                                    <span>@column.DisplayName</span>
                                    <i class="sort-icon fas @(Model.OrderBy == column.Name
                                                ? (Model.OrderDirection == "desc" ? "fa-sort-down" : "fa-sort-up")
                                                : "fa-sort")"
                                        data-sort="@column.Name"></i>
                                </div>
                            }
                            else
                            {
                                @column.DisplayName
                            }
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (Model.Items?.Count > 0)
                {
                    @foreach (var item in Model.Items)
                    {
                        var itemType = item.GetType();
                        var itemId = itemType.GetProperty("Id")?.GetValue(item)?.ToString();

                        <tr class="grid-row"
                            data-id="@itemId"
                            data-controller="@Model.ControllerName"
                            role="row"
                            tabindex="0">
                            @foreach (var column in Model.Columns)
                            {
                                <td role="gridcell" class="grid-cell @(column.Type == EnumGridColumnType.Actions ? "actions-cell" : "")">
                                    <div class="cell-content">
                                        @await Html.PartialAsync("_GridCell", new GridCellViewModel
                                        {
                                            Item = item,
                                            Column = column,
                                            Actions = column.Type == EnumGridColumnType.Actions
                                                ? Model.RowActions?.Where(a => a.ShowCondition == null || a.ShowCondition(item)).ToList()
                                                : null
                                        })
                                    </div>
                                </td>
                        }
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@Model.Columns.Count" class="text-center py-5">
                            <div class="empty-state">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhum registro encontrado</h5>
                                <p class="text-muted">Tente ajustar os filtros ou adicionar novos registros.</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- DROPDOWN PORTAL - Renderizado fora da tabela -->
    <div id="dropdownPortal" class="dropdown-portal"></div>

    <!-- Controles da Grid -->
    <div class="grid-controls">
        <div class="d-flex justify-content-between align-items-center">
            <div class="results-info">
                <span class="text-muted">
                    Exibindo @((Model.CurrentPage - 1) * Model.PageSize + 1)-@(Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalRecords))
                    de @Model.TotalRecords.ToString("N0") resultados
                </span>
            </div>

            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    <label class="form-label-small mb-0">Itens por página:</label>
                    <select id="pageSizeSelector" class="form-select form-select-sm" style="width: auto;">
                        <option value="50" selected="@(Model.PageSize == 50)">50</option>
                        <option value="100" selected="@(Model.PageSize == 100)">100</option>
                        <option value="200" selected="@(Model.PageSize == 200)">200</option>
                        <option value="-1" selected="@(Model.PageSize == -1)">Todos</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

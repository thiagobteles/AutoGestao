@model GridCellViewModel
@using AutoGestao.Enumerador.Gerais
@using AutoGestao.Extensions
@using AutoGestao.Models
@using AutoGestao.Models.Grid
@using AutoGestao.Services.Interface

@inject AutoGestao.Services.Interface.IFileStorageService FileStorageService

@{
    var itemType = Model.Item.GetType();
    var propertyInfo = itemType.GetProperty(Model.Column.Name);
    var value = propertyInfo?.GetValue(Model.Item);
    var formFieldAttr = propertyInfo?.GetCustomAttribute<FormFieldAttribute>();
}

@switch (Model.Column.Type)
{
    case EnumGridColumnType.Actions:
        @if (Model.Actions != null && Model.Actions.Any())
        {
            var visibleActions = Model.Actions.Where(action => action.ShowCondition == null || action.ShowCondition(Model.Item)).ToList();
            @if (visibleActions.Any())
            {
                var itemId = itemType.GetProperty("Id")?.GetValue(Model.Item)?.ToString();

                <!-- DROPDOWN CONTAINER -->
                <div class="action-dropdown-container" data-item-id="@itemId">
                    <button type="button"
                            class="btn-actions-enhanced"
                            data-dropdown-toggle="dropdown-@itemId"
                            aria-expanded="false"
                            title="Ações disponíveis">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>

                    <!-- DROPDOWN ITEMS DATA (Hidden, usado pelo JS) -->
                    <script type="application/json" class="dropdown-data">
                        {
                            "actions": [
                                @foreach (var action in visibleActions)
                                {
                                        var actionUrl = action.Url?.Replace("{id}", itemId);
                                        var requestTypeValue = (int)action.Type;
                                        var targetValue = action.Target ?? "";
                                        <text>{
                                            "name": "@action.Name",
                                            "displayName": "@action.DisplayName",
                                            "icon": "@action.Icon",
                                            "url": "@Html.Raw(actionUrl)",
                                            "type": @requestTypeValue,
                                            "cssClass": "@(action.Name.ToLower().Contains("delete") || action.Name.ToLower().Contains("excluir") ? "text-danger" : "")",
                                            "target": "@targetValue"
                                        }</text>
                                        @if (action != visibleActions.Last())
                                        {
                                            <text>,</text>
                                        }
                                }
                            ]
                        }
                    </script>
                </div>
            }
        }
        break;

    case EnumGridColumnType.Enumerador:
        @try
        {
            if (value is Enum enumValue)
            {
                var icone = enumValue.GetIcone();
                var descricao = enumValue.GetDescription();

                <span class="person-type">
                    @if (Model.Column.EnumRender == EnumRenderType.Icon)
                    {
                        // Mostra apenas o ícone se existir, senão mostra a descrição
                        if (!string.IsNullOrEmpty(icone))
                        {
                            <i class="@icone" title="@descricao"></i>
                        }
                        else
                        {
                            @descricao
                        }
                    }
                    else if (Model.Column.EnumRender == EnumRenderType.IconDescription)
                    {
                        // Mostra ícone + descrição
                        if (!string.IsNullOrEmpty(icone))
                        {
                            <i class="@icone me-1"></i>
                        }
                        @descricao
                    }
                    else if (Model.Column.EnumRender == EnumRenderType.DescriptionIcon)
                    {
                        // Mostra descrição + ícone
                        @descricao
                        if (!string.IsNullOrEmpty(icone))
                        {
                            <i class="@icone ms-1"></i>
                        }
                    }
                    else
                    {
                        // EnumRenderType.Description - mostra apenas a descrição
                        @descricao
                    }
                </span>
            }
            else if (value != null && bool.TryParse(value.ToString(), out bool enumBoolValue))
            {
                <span class="status-badge @(enumBoolValue ? "status-active" : "status-inactive")">
                    @(enumBoolValue ? "✅" : "❌")
                </span>
            }
            else
            {
                <span class="person-type">@value</span>
            }
        }
        catch
        {
            @value
        }
        break;

    case EnumGridColumnType.Currency:
        @if (value != null)
        {
            decimal currencyValue = 0;
            bool parsed = false;

            if (value is decimal decVal)
            {
                currencyValue = decVal;
                parsed = true;
            }
            else if (decimal.TryParse(value.ToString(), out decimal parsedVal))
            {
                currencyValue = parsedVal;
                parsed = true;
            }

            if (parsed)
            {
                <span class="currency-value">@currencyValue.ToString("C2")</span>
            }
            else
            {
                <span class="text-muted">-</span>
            }
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.Date:
        @if (value != null && DateTime.TryParse(value.ToString(), out DateTime dateValue))
        {
            @dateValue.ToString("dd/MM/yyyy")
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.DateTime:
        @if (value != null && value is DateTime dateTimeValue)
        {
            <span>@dateTimeValue.ToString("dd/MM/yyyy HH:mm")</span>
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.Number:
        @if (value != null)
        {
            decimal numberValue = 0;
            bool parsed = false;

            if (value is decimal decVal)
            {
                numberValue = decVal;
                parsed = true;
            }
            else if (decimal.TryParse(value.ToString(), out decimal parsedVal))
            {
                numberValue = parsedVal;
                parsed = true;
            }

            if (parsed)
            {
                // Usar o formato especificado na coluna, ou N0 como padrão
                var format = !string.IsNullOrEmpty(Model.Column.Format) ? Model.Column.Format : "N0";

                // Se o formato for P (porcentagem), dividir por 100
                if (format.StartsWith("P", StringComparison.OrdinalIgnoreCase))
                {
                    numberValue = numberValue / 100;
                }

                <span class="number-value">@numberValue.ToString(format)</span>
            }
            else
            {
                <span class="text-muted">-</span>
            }
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.Integer:
        @if (value != null && long.TryParse(value.ToString(), out long integerValue))
        {
            @integerValue.ToString()
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.Boolean:
        @if (value != null && bool.TryParse(value.ToString(), out bool boolValue))
        {
            <span class="status-badge @(boolValue ? "status-active" : "status-inactive")">
                <i class="fas @(boolValue ? "fa-check" : "fa-times")"></i>
                @(boolValue ? "Sim" : "Não")
            </span>
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.Custom:
        @if (Model.Column.CustomRender != null)
        {
            @Html.Raw(Model.Column.CustomRender(Model.Item))
        }
        else
        {
            @(value ?? "-")
        }
        break;

    case EnumGridColumnType.Text:
        @* RENDERIZAR IMAGEM NA GRID *@
        @if (formFieldAttr?.Type == EnumFieldType.Image && value != null && !string.IsNullOrEmpty(value.ToString()))
        {
            try
            {
                var filePath = value.ToString();
                var entityName = itemType.Name;
                var idEmpresa = GetCurrentEmpresaId();

                var imageUrl = FileStorageService.GetDownloadUrlAsync(filePath, entityName, idEmpresa).GetAwaiter().GetResult();
                var size = formFieldAttr.ImageSize.Split('x');
                var width = size.Length > 0 ? size[0] : "50";
                var height = size.Length > 1 ? size[1] : "50";

                <img src="@imageUrl"
                     alt="Imagem"
                     class="img-thumbnail"
                     style="max-width:@(width)px; max-height:@(height)px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                     loading="lazy"
                     onclick="window.open('@imageUrl', '_blank')"
                     title="Clique para ampliar" />
            }
            catch
            {
                <i class="fas fa-image text-muted" title="Erro ao carregar imagem"></i>
            }
        }
        @* RENDERIZAR ARQUIVO NA GRID *@
        else if (formFieldAttr?.Type == EnumFieldType.File && value != null && !string.IsNullOrEmpty(value.ToString()))
        {
            var fileName = System.IO.Path.GetFileName(value.ToString());
            var extension = System.IO.Path.GetExtension(fileName).ToLower();

            var icon = extension switch
            {
                ".pdf" => "fa-file-pdf text-danger",
                ".doc" or ".docx" => "fa-file-word text-primary",
                ".xls" or ".xlsx" => "fa-file-excel text-success",
                ".jpg" or ".jpeg" or ".png" or ".gif" => "fa-file-image text-info",
                ".zip" or ".rar" => "fa-file-archive text-warning",
                _ => "fa-file text-secondary"
            };

            <span title="@fileName">
                <i class="fas @icon me-1"></i>
                <small>@fileName</small>
            </span>
        }
        else
        {
            @* TEXTO NORMAL COM LINK SE NECESSÁRIO *@
            if (!string.IsNullOrEmpty(Model.Column.UrlAction))
            {
                var itemId = itemType.GetProperty("Id")?.GetValue(Model.Item)?.ToString();
                var controller = ViewContext.RouteData.Values["controller"]?.ToString();
                <a href="/@controller/@Model.Column.UrlAction/@itemId" class="text-decoration-none text-primary">
                    @value
                </a>
            }
            else
            {
                <text>@value</text>
            }
        }
        break;

    case EnumGridColumnType.Image:
        @if (value != null)
        {
            var imageUrl = value.ToString();
            if (!string.IsNullOrEmpty(imageUrl))
            {
                <div class="grid-image-cell">
                    <img src="@imageUrl" alt="Imagem" class="grid-thumbnail" />
                </div>
            }
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.File:
        @if (value != null)
        {
            var filePath = value.ToString();
            if (!string.IsNullOrEmpty(filePath))
            {
                var fileName = System.IO.Path.GetFileName(filePath);
                var entityName = itemType.Name;
                var itemId = itemType.GetProperty("Id")?.GetValue(Model.Item);
                var empresaIdProp = itemType.GetProperty("IdEmpresa");
                var empresaId = empresaIdProp?.GetValue(Model.Item) ?? 1;

                <div class="grid-file-cell">
                    <a href="@Url.Action("DownloadFile", new { 
                        propertyName = Model.Column.Name, 
                        filePath = filePath, 
                        customBucket = formFieldAttr?.CustomBucket 
                    })" 
                       class="file-download-link" 
                       title="Download: @fileName">
                        <i class="fas fa-file-download"></i>
                        <span class="file-name">@fileName</span>
                    </a>
                </div>
            }
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    case EnumGridColumnType.Percentage:
        @if (value != null)
        {
            var percentValue = Convert.ToDecimal(value);
            <span>@percentValue.ToString("P2")</span>
        }
        else
        {
            <span class="text-muted">-</span>
        }
        break;

    default:
        @if (!string.IsNullOrEmpty(Model.Column.UrlAction))
        {
            <a href="@Url.Action(Model.Column.UrlAction, new { id = itemType.GetProperty("Id")?.GetValue(Model.Item) })"
               class="text-decoration-none text-primary fw-medium text-truncate">
                @value
            </a>
        }
        else
        {
            <span class="text-truncate" title="@value">@(value ?? "-")</span>
        }
        break;
}

@functions {
    private long GetCurrentEmpresaId()
    {
        var empresaIdClaim = User.FindFirst("EmpresaId")?.Value;
        if (long.TryParse(empresaIdClaim, out var empresaId))
            return empresaId;

        return 1;
    }
}
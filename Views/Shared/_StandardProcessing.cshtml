@model ProcessingFormViewModel
@{
    ViewData["Title"] = Model.Title;
}

<div class="dashboard-container fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title">
                <i class="@Model.Icon"></i>
                @Model.Title
            </h1>
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <p class="page-subtitle mb-0">@Model.Description</p>
            }
        </div>
    </div>

    @* Exibir resultado do √∫ltimo processamento (se houver) *@
    @if (Model.LastResult != null)
    {
        <div class="alert @(Model.LastResult.Success ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-start">
                <i class="@(Model.LastResult.Success ? "fas fa-check-circle" : "fas fa-exclamation-triangle") me-2 mt-1"></i>
                <div class="flex-grow-1">
                    <strong>@(Model.LastResult.Success ? "Sucesso!" : "Erro!")</strong>
                    <p class="mb-0">@Model.LastResult.Message</p>

                    @if (Model.LastResult.Warnings.Any())
                    {
                        <div class="mt-2">
                            <strong>Avisos:</strong>
                            <ul class="mb-0">
                                @foreach (var warning in Model.LastResult.Warnings)
                                {
                                    <li>@warning</li>
                                }
                            </ul>
                        </div>
                    }

                    @if (Model.LastResult.Errors.Any())
                    {
                        <div class="mt-2">
                            <strong>Erros:</strong>
                            <ul class="mb-0">
                                @foreach (var error in Model.LastResult.Errors)
                                {
                                    <li>@error</li>
                                }
                            </ul>
                        </div>
                    }

                    @if (Model.LastResult.Metadata.Any())
                    {
                        <div class="mt-2">
                            <strong>Informa√ß√µes adicionais:</strong>
                            <ul class="mb-0">
                                @foreach (var meta in Model.LastResult.Metadata)
                                {
                                    <li><strong>@meta.Key:</strong> @meta.Value</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @await Html.PartialAsync("_StandardProcessingContent", Model)
</div>

@section Scripts {
    <script>
        (function() {
            console.log('üöÄ Inicializando sistema de processamento...');

            const form = document.querySelector('.processing-form');
            const submitBtn = document.getElementById('btnProcessar');

            if (!form || !submitBtn) {
                console.error('Formul√°rio ou bot√£o de submit n√£o encontrado');
                return;
            }

            const btnText = submitBtn.querySelector('.btn-text');
            const btnIcon = submitBtn.querySelector('i');
            const originalText = btnText ? btnText.textContent : '';
            const originalIconClass = btnIcon ? btnIcon.className : '';

            const showConfirmation = @(Model.ShowConfirmation ? "true" : "false");
            const confirmationMessage = '@Html.Raw(Model.ConfirmationMessage ?? "Deseja realmente executar este processamento?")';
            const allowMultiple = @(Model.AllowMultipleExecutions ? "true" : "false");
            const redirectUrl = '@(Model.RedirectOnSuccessUrl ?? "")';
            const controllerName = '@Model.ControllerName';
            const processingKey = 'processing_' + controllerName;

            console.log('‚öôÔ∏è Configura√ß√£o:', { allowMultiple, controllerName, processingKey });

            // Sistema de bloqueio global
            const ProcessingLock = {
                isProcessing: function() {
                    const value = sessionStorage.getItem(processingKey);
                    console.log('üîí Verificando lock:', value);
                    return value === 'true';
                },
                lock: function() {
                    console.log('üîí Bloqueando processamento para:', processingKey);
                    sessionStorage.setItem(processingKey, 'true');
                },
                unlock: function() {
                    console.log('üîì Desbloqueando processamento para:', processingKey);
                    sessionStorage.removeItem(processingKey);
                }
            };

            // Limpar lock se a flag estiver setada (ap√≥s redirect de processamento)
            const clearLock = @(ViewBag.ClearProcessingLock != null ? "true" : "false");
            if (clearLock) {
                console.log('üîì Limpando lock anterior...');
                ProcessingLock.unlock();
            }

            // Verificar se j√° h√° processamento em andamento ao carregar a p√°gina
            if (ProcessingLock.isProcessing() && !allowMultiple) {
                console.log('‚ö†Ô∏è Processamento j√° em andamento, desabilitando bot√£o');
                submitBtn.disabled = true;
                if (btnText) btnText.textContent = 'Processamento em andamento...';
                if (btnIcon) btnIcon.className = 'fas fa-spinner fa-spin me-2';

                // Timeout de seguran√ßa: desbloquear ap√≥s 5 minutos se ainda estiver bloqueado
                setTimeout(function() {
                    if (ProcessingLock.isProcessing()) {
                        console.warn('‚è∞ Lock de processamento expirado ap√≥s 5 minutos, desbloqueando...');
                        ProcessingLock.unlock();
                        submitBtn.disabled = false;
                        if (btnText) btnText.textContent = originalText;
                        if (btnIcon) btnIcon.className = originalIconClass;
                    }
                }, 300000); // 5 minutos
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('üìù Formul√°rio submetido');

                // Verificar se j√° h√° processamento em andamento
                if (!allowMultiple && ProcessingLock.isProcessing()) {
                    console.warn('‚ùå Tentativa de processamento bloqueada - j√° existe um em andamento');
                    showProcessingAlert();
                    return false;
                }

                // Confirma√ß√£o
                if (showConfirmation) {
                    console.log('‚ùì Solicitando confirma√ß√£o...');
                    if (!confirm(confirmationMessage)) {
                        console.log('‚ùå Confirma√ß√£o cancelada pelo usu√°rio');
                        return false;
                    }
                }

                // Marcar como processando
                if (!allowMultiple) {
                    ProcessingLock.lock();
                }

                // Desabilitar bot√£o
                submitBtn.disabled = true;
                if (btnText) btnText.textContent = 'Processando...';
                if (btnIcon) btnIcon.className = 'fas fa-spinner fa-spin me-2';

                // Mostrar loading overlay
                showProcessingOverlay();

                console.log('‚úÖ Submetendo formul√°rio...');

                // Submeter o formul√°rio diretamente (n√£o AJAX, pois o controller faz redirect)
                form.submit();
            });

            function showProcessingAlert() {
                console.log('üö® Exibindo alerta de processamento em andamento');

                // Tentar usar o sistema de modal existente
                if (typeof showWarning === 'function') {
                    showWarning('J√° existe um processamento em andamento. Por favor, aguarde a conclus√£o antes de iniciar outro.', {
                        title: 'Processamento em Andamento',
                        buttonText: 'OK'
                    });
                } else if (typeof showError === 'function') {
                    showError('J√° existe um processamento em andamento. Por favor, aguarde a conclus√£o antes de iniciar outro.', {
                        title: 'Processamento em Andamento',
                        buttonText: 'OK'
                    });
                } else if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Processamento em Andamento',
                        text: 'J√° existe um processamento em andamento. Por favor, aguarde a conclus√£o antes de iniciar outro.',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#3b82f6'
                    });
                } else {
                    alert('J√° existe um processamento em andamento. Por favor, aguarde a conclus√£o antes de iniciar outro.');
                }
            }

            function showProcessingOverlay() {
                console.log('üìä Exibindo overlay de processamento');

                // Criar overlay se n√£o existir
                let overlay = document.getElementById('processingOverlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'processingOverlay';
                    overlay.innerHTML = `
                        <div class="processing-overlay-content">
                            <div class="processing-spinner">
                                <i class="fas fa-spinner fa-spin fa-3x"></i>
                            </div>
                            <div class="processing-text mt-3">
                                <h5>Processamento em andamento...</h5>
                                <p class="text-muted mb-0">Por favor, aguarde. N√£o feche esta janela.</p>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }
                overlay.style.display = 'flex';
            }

            console.log('‚úÖ Sistema de processamento inicializado com sucesso');
        })();
    </script>

    <style>
        #processingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .processing-overlay-content {
            background: white;
            padding: 3rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: fadeInScale 0.3s ease;
        }

        .processing-spinner i {
            color: #3b82f6;
        }

        .processing-text h5 {
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .processing-text p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        @@keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
}

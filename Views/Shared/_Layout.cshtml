@using AutoGestao.Entidades
@using AutoGestao.Entidades.Veiculos
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - @Globais.NomeApresentacao</title>

    <!-- TEMA: Cores centralizadas do sistema (edite aqui para mudar cores) -->
    @if (Globais.CorSistema == EnumCorSistema.Amarelo)
    {
        <link rel="stylesheet" href="~/css/theme-colors-yellow.css" asp-append-version="true" />
    }
    else if (Globais.CorSistema == EnumCorSistema.Vermelho)
    {
        <link rel="stylesheet" href="~/css/theme-colors-red.css" asp-append-version="true" />
    }
    else if (Globais.CorSistema == EnumCorSistema.Verde)
    {
        <link rel="stylesheet" href="~/css/theme-colors-green.css" asp-append-version="true" />
    }
    else
    {
        <link rel="stylesheet" href="~/css/theme-colors-blue.css" asp-append-version="true" />
    }

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/custom.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/image.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/collapsible-menu.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/reference-field.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/file-upload.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/grid-system.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/complete-modal-styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/custom-select.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/alert-system.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

</head>
<body>
    <div class="layout-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <a href="@Url.Action("Index", "Home")" class="brand-logo">
                    <i class="fas fa-car"></i>
                    <div class="brand-text-content">
                        <span>AutoGestﾃ｣o</span>
                    </div>
                </a>
                <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Recolher Menu">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <nav class="sidebar-menu">
                <!-- Principal -->
                <div class="menu-section">
                    <div class="menu-section-title">Principal</div>
                    <div class="menu-item">
                        <a href="@Url.Action("Index", "Home")" class="menu-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Home" ? "active" : "")">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="menu-link-text">Dashboard</span>
                            <div class="menu-tooltip">Dashboard</div>
                        </a>
                    </div>
                </div>

                <!-- Cadastros com Submenus -->
                <div class="menu-section">
                    <div class="menu-section-title">Cadastros</div>

                    <!-- Menu Item Expansﾃｭvel: Empresas Clientes -->
                    <div class="menu-item has-submenu">
                        <a href="javascript:void(0)" class="menu-link menu-toggle">
                            <i class="fas fa-building"></i>
                            <span class="menu-link-text">Empresas</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                            <div class="menu-tooltip">Empresas</div>
                        </a>
                        <div class="submenu">
                            <div class="menu-item">
                                <a href="/EmpresaCliente/Index" class="menu-link submenu-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "EmpresaCliente" ? "active" : "")">
                                    <i class="fas fa-building"></i>
                                    <span class="menu-link-text">Empresas Clientes</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="/CertificadoDigital/Index" class="menu-link submenu-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "CertificadoDigital" ? "active" : "")">
                                    <i class="fas fa-certificate"></i>
                                    <span class="menu-link-text">Certificados Digitais</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="/CNAE/Index" class="menu-link submenu-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "CNAE" ? "active" : "")">
                                    <i class="fas fa-industry"></i>
                                    <span class="menu-link-text">CNAEs</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Menu Item Expansﾃｭvel: Fiscal -->
                    <div class="menu-item has-submenu">
                        <a href="javascript:void(0)" class="menu-link menu-toggle">
                            <i class="fas fa-file-invoice"></i>
                            <span class="menu-link-text">Fiscal</span>
                            <i class="fas fa-chevron-down submenu-arrow"></i>
                            <div class="menu-tooltip">Fiscal</div>
                        </a>
                        <div class="submenu">
                            <div class="menu-item">
                                <a href="/NotaFiscal/Index" class="menu-link submenu-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "NotaFiscal" ? "active" : "")">
                                    <i class="fas fa-file-invoice"></i>
                                    <span class="menu-link-text">Notas Fiscais</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="/NotaFiscal/Create" class="menu-link submenu-link">
                                    <i class="fas fa-plus-circle"></i>
                                    <span class="menu-link-text">Emitir Nota</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="/NotaFiscal/ImportarXML" class="menu-link submenu-link">
                                    <i class="fas fa-file-import"></i>
                                    <span class="menu-link-text">Importar XML</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relatﾃｳrios -->
                @if (User.IsInRole("Admin") || User.IsInRole("Gerente") || User.IsInRole("Financeiro"))
                {
                    <div class="menu-section">
                        <div class="menu-section-title">Relatﾃｳrios</div>
                        <div class="menu-item has-submenu">
                            <a href="javascript:void(0)" class="menu-link menu-toggle">
                                <i class="fas fa-chart-line"></i>
                                <span class="menu-link-text">Relatﾃｳrios</span>
                                <i class="fas fa-chevron-down submenu-arrow"></i>
                                <div class="menu-tooltip">Relatﾃｳrios</div>
                            </a>
                            <div class="submenu">
                                <div class="menu-item">
                                    <a href="@Url.Action("Index", "ReportTemplate")" class="menu-link submenu-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "ReportTemplate" ? "active" : "")">
                                        <i class="fas fa-file-alt"></i>
                                        <span class="menu-link-text">Templates de Relatﾃｳrios</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </nav>
        </aside>

        <!-- Overlay para mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- ﾃ〉ea Principal -->
        <div class="main-area">
            <!-- Topbar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <nav class="breadcrumb breadcrumb-custom">
                        <span class="breadcrumb-item">Sistema</span>
                        <span class="breadcrumb-item active">@ViewData["Title"]</span>
                    </nav>
                </div>
                <div class="topbar-right">
                    <partial name="_LoginPartial" />
                </div>
            </header>

            <!-- Conteﾃｺdo Principal -->
            <main class="main-content fade-in">
                @RenderBody()
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts de validaﾃｧﾃ｣o -->
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/dist/jquery.validate.unobtrusive.min.js"></script>
    <script src="~/js/validation-pt-br.js"></script>

    <!-- Scripts da aplicaﾃｧﾃ｣o -->
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/alert-system.js" asp-append-version="true"></script>
    <script src="~/js/controller-utils.js" asp-append-version="true"></script>
    <script src="~/js/standard-form.js" asp-append-version="true"></script>
    <script src="~/js/conditional-fields.js" asp-append-version="true"></script>
    <script src="~/js/itemvenda.js" asp-append-version="true"></script>
    <script src="~/js/file-upload.js" asp-append-version="true"></script>
    <script src="~/js/tab-system.js" asp-append-version="true"></script>
    <script src="~/js/tab-content.js" asp-append-version="true"></script>
    <script src="~/js/complete-modal-system.js" asp-append-version="true"></script>
    <script src="~/js/modal-form-validation.js" asp-append-version="true"></script>
    <script src="~/js/response-handlers.js" asp-append-version="true"></script>
    <script src="~/js/report-template-selector.js" asp-append-version="true"></script>
    <script src="~/js/grid-specific-fixes.js" asp-append-version="true"></script>
    <script src="~/js/grid-controller-resolver.js" asp-append-version="true"></script>
    <script src="~/js/grid-enhanced.js" asp-append-version="true"></script>
    <script src="~/js/grid-action-handler.js" asp-append-version="true"></script>
    <script src="~/js/grid-enhanced-patch.js" asp-append-version="true"></script>

    <!-- Esse script da aplicaﾃｧﾃ｣o vem sempre no final -->
    <script src="~/js/reference-field.js" asp-append-version="true"></script>
    <script src="~/js/custom-select.js" asp-append-version="true"></script>

    <!-- SISTEMA DE SIDEBAR E LAYOUT -->
    <script>
        // CRﾃ控ICO: Aplicar estado collapsed IMEDIATAMENTE antes de qualquer outra coisa
        (function() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;

            // Adicionar classe no-transition para evitar flash visual
            sidebar.classList.add('no-transition');

            const savedCollapsedState = localStorage.getItem('sidebarCollapsed') === 'true';
            if (savedCollapsedState) {
                sidebar.classList.add('collapsed');
            }

            // Remover no-transition apﾃｳs um frame para permitir transiﾃｧﾃｵes futuras
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    sidebar.classList.remove('no-transition');
                });
            });
        })();

        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            // Variﾃ｡vel para controlar se estamos processando um clique
            let isProcessingClick = false;

            // Atualizar ﾃｭcone baseado no estado jﾃ｡ aplicado
            const isCollapsed = sidebar.classList.contains('collapsed');
            updateCollapseIcon(isCollapsed);

            // Garantir que no-transition seja removida apﾃｳs inicializaﾃｧﾃ｣o completa
            setTimeout(() => {
                sidebar.classList.remove('no-transition');
            }, 100);

            // Botﾃ｣o de colapsar/expandir
            sidebarCollapseBtn?.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (isProcessingClick) return;
                isProcessingClick = true;

                const isCollapsed = sidebar.classList.contains('collapsed');

                if (isCollapsed) {
                    sidebar.classList.remove('collapsed');
                    localStorage.setItem('sidebarCollapsed', 'false');
                    updateCollapseIcon(false);
                } else {
                    sidebar.classList.add('collapsed');
                    localStorage.setItem('sidebarCollapsed', 'true');
                    updateCollapseIcon(true);
                }

                setTimeout(() => {
                    isProcessingClick = false;
                }, 400);
            });

            sidebarToggle?.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (isProcessingClick) return;
                isProcessingClick = true;

                const isCollapsed = sidebar.classList.contains('collapsed');

                if (isCollapsed) {
                    sidebar.classList.remove('collapsed');
                    localStorage.setItem('sidebarCollapsed', 'false');
                    updateCollapseIcon(false);
                } else {
                    sidebar.classList.add('collapsed');
                    localStorage.setItem('sidebarCollapsed', 'true');
                    updateCollapseIcon(true);
                }

                setTimeout(() => {
                    isProcessingClick = false;
                }, 400);
            });

            // Fechar sidebar ao clicar no overlay (mobile)
            sidebarOverlay?.addEventListener('click', function() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('show');
            });

            // Atualizar ﾃｭcone do botﾃ｣o de colapsar
            function updateCollapseIcon(isCollapsed) {
                const icon = sidebarCollapseBtn?.querySelector('i');
                if (icon) {
                    if (isCollapsed) {
                        icon.className = 'fas fa-chevron-right';
                        sidebarCollapseBtn.title = 'Expandir Menu';
                    } else {
                        icon.className = 'fas fa-chevron-left';
                        sidebarCollapseBtn.title = 'Recolher Menu';
                    }
                }
            }

            // Redimensionamento da janela
            window.addEventListener('resize', function() {
                if (window.innerWidth > 1024) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('show');
                }
            });
        });
    </script>

    <!-- SISTEMA DE MENU COLAPSﾃ〃EL -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('沐ｧ Inicializando menu colapsﾃ｡vel...');

            const sidebar = document.getElementById('sidebar');
            const isSidebarCollapsed = sidebar && sidebar.classList.contains('collapsed');

            console.log('沐ｧ Estado do sidebar ao inicializar menu:', isSidebarCollapsed ? 'COLLAPSED' : 'EXPANDED');

                // Selecionar todos os itens de menu que tﾃｪm submenu
                const menuToggles = document.querySelectorAll('.menu-toggle');

                menuToggles.forEach(toggle => {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const menuItem = this.closest('.menu-item.has-submenu');
                        const isExpanded = menuItem.classList.contains('expanded');

                        // Se o sidebar estiver colapsado, nﾃ｣o fazer nada
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar.classList.contains('collapsed')) {
                            return;
                        }

                        // Fechar outros submenus da mesma seﾃｧﾃ｣o
                        const parentSection = menuItem.closest('.menu-section');
                        const otherExpandedItems = parentSection.querySelectorAll('.menu-item.has-submenu.expanded');
                        otherExpandedItems.forEach(item => {
                            if (item !== menuItem) {
                                item.classList.remove('expanded');
                            }
                        });

                        // Toggle do item atual
                        if (isExpanded) {
                            menuItem.classList.remove('expanded');
                            menuItem.classList.remove('manual-expand');
                        } else {
                            menuItem.classList.add('expanded');
                            // 沐ｧ FIX: Adicionar classe manual-expand para ativar animaﾃｧﾃｵes
                            menuItem.classList.add('manual-expand');

                            // Remover a classe manual-expand apﾃｳs as animaﾃｧﾃｵes terminarem
                            setTimeout(() => {
                                menuItem.classList.remove('manual-expand');
                            }, 600); // 0.3s de animaﾃｧﾃ｣o + delays
                        }
                    });
                });

                // Expandir automaticamente o submenu se houver um item ativo dentro dele
                // SOMENTE se o sidebar nﾃ｣o estiver colapsado
                function expandActiveSubmenu() {
                    const sidebar = document.getElementById('sidebar');
                    const isCollapsed = sidebar && sidebar.classList.contains('collapsed');

                    // Nﾃ｣o expandir se o sidebar estiver colapsado
                    if (isCollapsed) {
                        console.log('沒 Submenu Nﾃグ expandido (sidebar collapsed)');
                        return;
                    }

                    const activeLinks = document.querySelectorAll('.submenu-link.active');
                    activeLinks.forEach(link => {
                        const menuItem = link.closest('.menu-item.has-submenu');
                        if (menuItem && !menuItem.classList.contains('expanded')) {
                            // Usar requestAnimationFrame para evitar flash visual
                            requestAnimationFrame(() => {
                                menuItem.classList.add('expanded');
                                menuItem.classList.add('has-active-child');
                                // 沐ｧ FIX: Nﾃグ adicionar 'manual-expand' aqui - expansﾃ｣o automﾃ｡tica nﾃ｣o deve animar
                                console.log('沒 Submenu expandido automaticamente (contﾃｩm item ativo)');
                            });
                        }
                    });
                }

                // Executar ao carregar SOMENTE se nﾃ｣o estiver collapsed
                if (!isSidebarCollapsed) {
                    // Aguardar um frame para garantir que o DOM estﾃ｡ completamente renderizado
                    requestAnimationFrame(() => {
                        expandActiveSubmenu();
                    });
                }

                // 沐ｧ FIX: Navegaﾃｧﾃ｣o AJAX para evitar reload da pﾃ｡gina
                function setupAjaxNavigation() {
                    // Interceptar cliques em links do submenu
                    const submenuLinks = document.querySelectorAll('.submenu-link');

                    submenuLinks.forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();

                            const url = this.getAttribute('href');
                            if (!url || url === '#' || url === 'javascript:void(0)') return;

                            // Remover classe active de todos os links
                            document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
                            document.querySelectorAll('.submenu-link').forEach(l => l.classList.remove('active'));

                            // Adicionar classe active no link clicado
                            this.classList.add('active');

                            // Mostrar loading
                            const mainContent = document.querySelector('.main-content');
                            if (mainContent) {
                                mainContent.style.opacity = '0.5';
                                mainContent.style.pointerEvents = 'none';
                            }

                            // Fazer requisiﾃｧﾃ｣o AJAX
                            fetch(url)
                                .then(response => response.text())
                                .then(html => {
                                    // Criar elemento temporﾃ｡rio para parsear o HTML
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = html;

                                    // Tentar extrair o conteﾃｺdo de .main-content da resposta
                                    // (quando servidor retorna pﾃ｡gina completa com layout)
                                    const newMainContent = tempDiv.querySelector('.main-content');

                                    if (mainContent) {
                                        // Se encontrou .main-content na resposta, usar apenas esse conteﾃｺdo
                                        // Caso contrﾃ｡rio, usar todo o HTML (partial view sem layout)
                                        mainContent.innerHTML = newMainContent ? newMainContent.innerHTML : html;

                                        // Atualizar URL sem reload
                                        window.history.pushState({}, '', url);

                                        // Aguardar um frame para garantir que o DOM foi atualizado
                                        requestAnimationFrame(() => {
                                            // Reinicializar scripts necessﾃ｡rios

                                            // 沐ｧ REMOVIDO: Nﾃ｣o executar scripts inline da resposta AJAX
                                            // Motivo: Podem conter cﾃｳdigo Razor ou sintaxe invﾃ｡lida fora do contexto do servidor
                                            // Os componentes necessﾃ｡rios sﾃ｣o reinicializados manualmente abaixo

                                            // 1. Reinicializar grid system
                                            if (typeof StandardGrid !== 'undefined') {
                                                const gridContainer = document.querySelector('#gridContainer');
                                                if (gridContainer) {
                                                    console.log('沐 Reinicializando StandardGrid...');
                                                    window.gridInstance = new StandardGrid();

                                                    // 沐ｧ FIX: Carregar dados iniciais da grid apﾃｳs reinicializaﾃｧﾃ｣o
                                                    setTimeout(() => {
                                                        if (window.gridInstance && typeof window.gridInstance.aplicarFiltros === 'function') {
                                                            console.log('沐 Carregando dados iniciais da grid...');
                                                            window.gridInstance.aplicarFiltros(1);
                                                        }
                                                    }, 150);
                                                }
                                            }

                                            // 2. Reinicializar custom selects
                                            if (typeof window.initializeCustomSelects === 'function') {
                                                console.log('沐 Reinicializando custom selects...');
                                                window.initializeCustomSelects();
                                            } else if (typeof initializeCustomSelects === 'function') {
                                                console.log('沐 Reinicializando custom selects (global)...');
                                                initializeCustomSelects();
                                            }

                                            // 3. Reinicializar reference fields
                                            if (typeof window.initializeReferenceFields === 'function') {
                                                console.log('沐 Reinicializando reference fields...');
                                                window.initializeReferenceFields();
                                            } else if (typeof initializeReferenceFields === 'function') {
                                                console.log('沐 Reinicializando reference fields (global)...');
                                                initializeReferenceFields();
                                            }

                                            // 4. Reinicializar dropdown portal system
                                            // 沐ｧ FIX: Nﾃグ reinicializar DropdownPortalSystem
                                            // Motivo: Usa event delegation no document, jﾃ｡ funciona globalmente
                                            // Reinicializar cria event listeners duplicados causando posicionamento incorreto
                                            if (typeof DropdownPortalSystem !== 'undefined' && !window.dropdownPortalSystem) {
                                                console.log('沐 Inicializando dropdown portal...');
                                                window.dropdownPortalSystem = new DropdownPortalSystem();
                                            }

                                            // 5. Disparar evento customizado para outros scripts
                                            document.dispatchEvent(new CustomEvent('ajaxContentLoaded'));

                                            // Restaurar opacidade
                                            mainContent.style.opacity = '1';
                                            mainContent.style.pointerEvents = 'auto';

                                            // Scroll para o topo
                                            mainContent.scrollTop = 0;

                                            console.log('笨 Navegaﾃｧﾃ｣o AJAX concluﾃｭda com sucesso');
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error('Erro ao carregar pﾃ｡gina:', error);
                                    // Em caso de erro, fazer navegaﾃｧﾃ｣o normal
                                    window.location.href = url;
                                });
                        });
                    });
                }

                // Inicializar navegaﾃｧﾃ｣o AJAX
                setupAjaxNavigation();

                // 沐ｧ FIX: Suporte para botﾃｵes voltar/avanﾃｧar do navegador
                window.addEventListener('popstate', function(event) {
                    // Recarregar a pﾃ｡gina quando usar botﾃ｣o voltar/avanﾃｧar
                    location.reload();
                });

                // Fechar todos os submenus quando o sidebar for colapsado
                const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
                const sidebarToggle = document.getElementById('sidebarToggle');

                function closeAllSubmenus() {
                    const expandedItems = document.querySelectorAll('.menu-item.has-submenu.expanded');
                    expandedItems.forEach(item => {
                        item.classList.remove('expanded');
                    });
                    console.log('沒 Todos os submenus fechados');
                }

                if (sidebarCollapseBtn) {
                    sidebarCollapseBtn.addEventListener('click', function() {
                        setTimeout(closeAllSubmenus, 50);
                    });
                }

                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', function() {
                        setTimeout(closeAllSubmenus, 50);
                    });
                }

                // Salvar estado dos submenus no localStorage
                function saveSubmenuState() {
                    const sidebar = document.getElementById('sidebar');
                    // Nﾃ｣o salvar estado se sidebar estiver collapsed
                    if (sidebar && sidebar.classList.contains('collapsed')) {
                        return;
                    }

                    const expandedMenus = [];
                    document.querySelectorAll('.menu-item.has-submenu.expanded').forEach(item => {
                        const menuLink = item.querySelector('.menu-toggle');
                        const menuText = menuLink ? menuLink.querySelector('.menu-link-text')?.textContent : null;
                        if (menuText) {
                            expandedMenus.push(menuText);
                        }
                    });
                    localStorage.setItem('expandedMenus', JSON.stringify(expandedMenus));
                }

                // Restaurar estado dos submenus do localStorage
                // SOMENTE se o sidebar nﾃ｣o estiver colapsado
                function restoreSubmenuState() {
                    const sidebar = document.getElementById('sidebar');
                    const isCollapsed = sidebar && sidebar.classList.contains('collapsed');

                    // Nﾃ｣o restaurar se o sidebar estiver colapsado
                    if (isCollapsed) {
                        console.log('沒 Estado dos submenus Nﾃグ restaurado (sidebar collapsed)');
                        return;
                    }

                    try {
                        const savedMenus = JSON.parse(localStorage.getItem('expandedMenus') || '[]');
                        savedMenus.forEach(menuText => {
                            const menuLinks = document.querySelectorAll('.menu-toggle');
                            menuLinks.forEach(link => {
                                const linkText = link.querySelector('.menu-link-text')?.textContent;
                                if (linkText === menuText) {
                                    const menuItem = link.closest('.menu-item.has-submenu');
                                    if (menuItem && !menuItem.classList.contains('expanded')) {
                                        // Usar requestAnimationFrame para evitar flash visual
                                        requestAnimationFrame(() => {
                                            menuItem.classList.add('expanded');
                                            console.log('沒 Submenu restaurado:', menuText);
                                        });
                                    }
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Erro ao restaurar estado dos submenus:', error);
                    }
                }

                // Restaurar estado salvo SOMENTE se nﾃ｣o estiver collapsed
                if (!isSidebarCollapsed) {
                    // Aguardar um frame para garantir que o DOM estﾃ｡ completamente renderizado
                    requestAnimationFrame(() => {
                        restoreSubmenuState();
                    });
                }

                // Salvar estado quando um submenu for expandido/colapsado
                menuToggles.forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        setTimeout(saveSubmenuState, 50);
                    });
                });

            console.log('笨 Menu colapsﾃ｡vel inicializado com sucesso');
        });
    </script>

    <!-- Sistema de Grid Unificado -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variﾃ｡veis globais para controle da grid
            let isLoadingVisible = false;
            let loadingTimeout = null;

            // ===================================================================
            // FUNﾃﾃグ PARA CONTROLAR LOADING
            // ===================================================================
            window.showLoading = function(show) {
                const overlay = document.getElementById('loadingOverlay');

                if (!overlay) {
                    console.warn('Loading overlay nﾃ｣o encontrado');
                    return;
                }

                // Limpar timeout anterior
                if (loadingTimeout) {
                    clearTimeout(loadingTimeout);
                    loadingTimeout = null;
                }

                if (show) {
                    isLoadingVisible = true;
                    overlay.classList.remove('d-none');
                    overlay.style.display = 'flex';
                    overlay.style.opacity = '1';
                    overlay.style.visibility = 'visible';

                    // Adicionar classe loading ﾃ tabela
                    const table = document.querySelector('.base-grid-table');
                    if (table) {
                        table.classList.add('loading');
                    }

                    // Timeout de seguranﾃｧa - forﾃｧar esconder apﾃｳs 15 segundos
                    loadingTimeout = setTimeout(() => {
                        console.warn('Loading forﾃｧado a esconder apﾃｳs timeout');
                        showLoading(false);
                    }, 15000);

                } else {
                    isLoadingVisible = false;
                    overlay.style.opacity = '0';

                    // Remover classe loading da tabela
                    const table = document.querySelector('.base-grid-table');
                    if (table) {
                        table.classList.remove('loading');
                    }

                    // Aguardar transiﾃｧﾃ｣o antes de esconder completamente
                    setTimeout(() => {
                        overlay.classList.add('d-none');
                        overlay.style.display = 'none';
                        overlay.style.visibility = 'hidden';
                    }, 300);
                }
            };

            // Funﾃｧﾃ｣o para forﾃｧar esconder loading (emergﾃｪncia)
            window.forceHideLoading = function() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    isLoadingVisible = false;
                    overlay.classList.add('d-none');
                    overlay.style.display = 'none';
                    overlay.style.opacity = '0';
                    overlay.style.visibility = 'hidden';

                    const table = document.querySelector('.base-grid-table');
                    if (table) {
                        table.classList.remove('loading');
                    }

                    if (loadingTimeout) {
                        clearTimeout(loadingTimeout);
                        loadingTimeout = null;
                    }
                }
            };

            // ===================================================================
            // FUNﾃﾃグ GENﾃ嘘ICA PARA APLICAR FILTROS
            // ===================================================================
            window.aplicarFiltros = function(page = 1) {
                // Prevenir mﾃｺltiplas requisiﾃｧﾃｵes
                if (isLoadingVisible) {
                    console.log('Jﾃ｡ carregando, ignorando nova requisiﾃｧﾃ｣o');
                    return;
                }

                showLoading(true);

                // 沐ｧ FIX: Formulﾃ｡rio de filtros ﾃｩ OPCIONAL
                // Se nﾃ｣o houver filtros definidos, ainda assim carrega os dados
                const filtrosForm = document.getElementById('filtrosForm');
                const pageSize = document.getElementById('pageSizeSelector')?.value || 50;

                const params = new URLSearchParams();
                params.append('page', page);
                params.append('pageSize', pageSize);

                // Adicionar filtros (se formulﾃ｡rio existir)
                if (filtrosForm) {
                    const formData = new FormData(filtrosForm);
                    for (let [key, value] of formData.entries()) {
                        if (value && value.trim() !== '') {
                            params.append(key, value);
                        }
                    }
                }

                // Determinar URL baseado na pﾃ｡gina atual
                const currentPath = window.location.pathname.toLowerCase();
                let ajaxUrl;

                let controller = gridControllerResolver.getCurrentController(); //this.getAttribute('data-controller');
                if (controller != null)
                {
                    ajaxUrl = `/${controller}/GetDataAjax`;
                }
                else
                {
                    console.error('URL Ajax nﾃ｣o identificada para:', currentPath);
                    forceHideLoading();
                    return;
                }

                fetch(`${ajaxUrl}?${params.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        const gridContainer = document.getElementById('gridContainer');
                        if (gridContainer) {
                            gridContainer.innerHTML = html;
                            updateUrl(params);
                            initializeGridEvents();
                        } else {
                            console.error('Grid container nﾃ｣o encontrado');
                        }
                    })
                    .catch(error => {
                        showError('Erro ao carregar dados: ' + error.message);
                    })
                    .finally(() => {
                        // Sempre esconder loading
                        setTimeout(() => {
                            showLoading(false);
                        }, 300); // Pequeno delay para UX melhor
                    });
            };

            // ===================================================================
            // FUNﾃﾃグ PARA MUDAR Pﾃ；INA
            // ===================================================================
            window.changePage = function(page) {
                aplicarFiltros(page);
            };

            // ===================================================================
            // FUNﾃﾃグ PARA ATUALIZAR URL
            // ===================================================================
            window.updateUrl = function(params) {
                try {
                    const newUrl = `${window.location.pathname}?${params.toString()}`;
                    window.history.replaceState({}, '', newUrl);
                } catch (error) {
                    console.error('Erro ao atualizar URL:', error);
                }
            };

            // ===================================================================
            // FUNﾃﾃグ PARA LIMPAR FILTROS
            // ===================================================================
            window.limparFiltros = function() {
                const form = document.getElementById('filtrosForm');
                if (form) {
                    form.reset();
                }

                const pageSize = document.getElementById('pageSizeSelector');
                if (pageSize) {
                    pageSize.value = '50';
                }

                aplicarFiltros(1);
            };

            // ===================================================================
            // FUNﾃﾃグ PARA ORDENAﾃﾃグ DE COLUNAS
            // ===================================================================
            window.sortColumn = function(column) {
                // Buscar campos hidden de ordenaﾃｧﾃ｣o (se existirem)
                let orderBy = document.getElementById('orderBy');
                let orderDirection = document.getElementById('orderDirection');

                // Se nﾃ｣o existirem, criar dinamicamente
                if (!orderBy) {
                    orderBy = document.createElement('input');
                    orderBy.type = 'hidden';
                    orderBy.id = 'orderBy';
                    orderBy.name = 'orderBy';
                    orderBy.value = 'Nome';
                    document.getElementById('filtrosForm').appendChild(orderBy);
                }

                if (!orderDirection) {
                    orderDirection = document.createElement('input');
                    orderDirection.type = 'hidden';
                    orderDirection.id = 'orderDirection';
                    orderDirection.name = 'orderDirection';
                    orderDirection.value = 'asc';
                    document.getElementById('filtrosForm').appendChild(orderDirection);
                }

                const currentOrder = orderBy.value;
                const currentDirection = orderDirection.value;

                // Se jﾃ｡ estﾃ｡ ordenando por esta coluna, inverte a direﾃｧﾃ｣o
                if (currentOrder === column) {
                    orderDirection.value = currentDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    orderBy.value = column;
                    orderDirection.value = 'asc';
                }

                aplicarFiltros();
            };

            // ===================================================================
            // FUNﾃﾃグ PARA CONFIRMAR EXCLUSﾃグ
            // ===================================================================
            window.confirmarExclusao = function(id) {
                if (confirm('Tem certeza que deseja excluir este registro? Esta aﾃｧﾃ｣o nﾃ｣o pode ser desfeita.')) {
                    const currentPath = window.location.pathname.toLowerCase();
                    let controller = window.gridControllerResolver.getCurrentController();

                    if (controller)
                    {
                        showLoading(true);
                        window.location.href = `/${controller}/Delete/${id}`;
                    }
                }
            };

            // ===================================================================
            // INICIALIZAﾃﾃグ DOS EVENTOS DA GRID
            // ===================================================================
            window.initializeGridEvents = function() {

                // Duplo clique nas linhas
                const rows = document.querySelectorAll('.grid-row');
                rows.forEach(row => {
                    // Remover eventos anteriores para evitar duplicaﾃｧﾃ｣o
                    row.removeEventListener('dblclick', handleRowDoubleClick);
                    row.addEventListener('dblclick', handleRowDoubleClick);
                });

                // Ordenaﾃｧﾃ｣o das colunas
                const sortIcons = document.querySelectorAll('.sort-icon');
                sortIcons.forEach(icon => {
                    icon.removeEventListener('click', handleSortClick);
                    icon.addEventListener('click', handleSortClick);
                });
            };

            // ===================================================================
            // HANDLERS DE EVENTOS
            // ===================================================================
            function handleRowDoubleClick(e) {
                // 沐ｧ FIX: Impedir duplo clique em elementos de dropdown, aﾃｧﾃｵes e empty-state
                if (e.target.closest('.dropdown') ||
                    e.target.closest('.actions-btn') ||
                    e.target.closest('.empty-state')) {
                    return;
                }

                const id = this.getAttribute('data-id');
                const controller = this.getAttribute('data-controller');

                // 沐ｧ FIX: Sﾃｳ redirecionar se houver id e controller vﾃ｡lidos
                if (id && controller) {
                    showLoading(true);

                    // Para ReportTemplate, redirecionar para ReportBuilder/Edit
                    if (controller === 'ReportTemplate') {
                        window.location.href = `/ReportBuilder/Edit/${id}`;
                    } else {
                        window.location.href = `/${controller}/Details/${id}`;
                    }
                }
            }

            function handleSortClick(e) {
                e.stopPropagation();
                const sortKey = this.getAttribute('data-sort');
                if (sortKey) {
                    sortColumn(sortKey);
                }
            }

            // ===================================================================
            // CONFIGURAﾃﾃグ INICIAL DOS FILTROS
            // ===================================================================
            function initializeFilters() {
                // Filtros com debounce para busca
                let searchTimeout;
                const searchInputs = [
                    'searchInput', 'searchCliente', 'searchVeiculo'
                ];

                searchInputs.forEach(inputId => {
                    const element = document.getElementById(inputId);
                    if (element) {
                        element.addEventListener('input', function() {
                            clearTimeout(searchTimeout);
                            searchTimeout = setTimeout(() => {
                                aplicarFiltros(1);
                            }, 600); // 600ms de delay
                        });
                    }
                });

                // Outros filtros aplicam imediatamente
                const immediateFilters = [
                    'filterSituacao', 'filterTipo', 'filterStatus',
                    'filterMarca', 'filterAno', 'filterCombustivel'
                ];

                immediateFilters.forEach(filterId => {
                    const element = document.getElementById(filterId);
                    if (element) {
                        element.addEventListener('change', () => aplicarFiltros(1));
                    }
                });

                // Seletor de tamanho de pﾃ｡gina
                const pageSizeSelector = document.getElementById('pageSizeSelector');
                if (pageSizeSelector) {
                    pageSizeSelector.addEventListener('change', function() {
                        aplicarFiltros(1);
                    });
                }
            }

            // ===================================================================
            // PREVENﾃﾃグ DE LOADING INFINITO
            // ===================================================================
            function setupLoadingProtection() {
                // Esconder loading inicial
                setTimeout(forceHideLoading, 1000);

                // Event listener para detectar quando a pﾃ｡gina termina de carregar
                window.addEventListener('load', function() {
                    setTimeout(forceHideLoading, 1500);
                });

                // Prevenir loading infinito em caso de erro de JavaScript
                window.addEventListener('error', function(event) {
                    console.error('Erro JavaScript detectado:', event.error);
                    forceHideLoading();
                });

                // Detectar mudanﾃｧas de visibilidade da pﾃ｡gina
                document.addEventListener('visibilitychange', function() {
                    if (document.visibilityState === 'visible' && isLoadingVisible) {
                        setTimeout(() => {
                            if (isLoadingVisible) {
                                console.warn('Loading ainda visﾃｭvel apﾃｳs mudanﾃｧa de visibilidade, forﾃｧando esconder');
                                forceHideLoading();
                            }
                        }, 3000);
                    }
                });
            }

            // ===================================================================
            // UTILITﾃヽIOS DE DEBUG
            // ===================================================================
            window.debugGrid = function() {
                const overlay = document.getElementById('loadingOverlay');
                const table = document.querySelector('.base-grid-table');
                const rows = document.querySelectorAll('.grid-row');

                console.log('=== GRID DEBUG ===');
                console.log('Loading overlay:', {
                    exists: !!overlay,
                    visible: isLoadingVisible,
                    classes: overlay?.className,
                    style: overlay?.style.cssText
                });
                console.log('Table:', {
                    exists: !!table,
                    classes: table?.className,
                    rows: rows.length
                });
                console.log('Grid state:', {
                    isLoadingVisible,
                    hasTimeout: !!loadingTimeout
                });
            };

            // ===================================================================
            // MELHORIAS DE ACESSIBILIDADE
            // ===================================================================
            function setupAccessibility() {
                // Adicionar ARIA labels e roles
                const table = document.querySelector('.base-grid-table');
                if (table) {
                    table.setAttribute('role', 'grid');
                    table.setAttribute('aria-label', 'Tabela de dados com filtros e ordenaﾃｧﾃ｣o');
                }

                // Headers ordenﾃ｡veis
                const sortableHeaders = document.querySelectorAll('[data-sortable]');
                sortableHeaders.forEach(header => {
                    header.setAttribute('role', 'columnheader');
                    header.setAttribute('tabindex', '0');
                    header.setAttribute('aria-sort', 'none');

                    // Permitir ordenaﾃｧﾃ｣o via teclado
                    header.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            const sortKey = this.getAttribute('data-sortable');
                            if (sortKey) {
                                sortColumn(sortKey);
                            }
                        }
                    });
                });

                // Linhas da grid
                const rows = document.querySelectorAll('.grid-row');
                rows.forEach((row, index) => {
                    row.setAttribute('role', 'row');
                    row.setAttribute('tabindex', '0');
                    row.setAttribute('aria-rowindex', index + 2); // +2 porque header ﾃｩ 1

                    // Navegaﾃｧﾃ｣o por teclado
                    row.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            this.dispatchEvent(new MouseEvent('dblclick'));
                        }
                    });
                });
            }

            // ===================================================================
            // INICIALIZAﾃﾃグ PRINCIPAL
            // ===================================================================
            function initializeGrid() {
                console.log('泅 Inicializando sistema de grid unificado...');

                // Configurar proteﾃｧﾃ｣o de loading
                setupLoadingProtection();

                // Inicializar filtros
                initializeFilters();

                // Inicializar eventos da grid
                initializeGridEvents();

                // Configurar acessibilidade
                setupAccessibility();

                // Forﾃｧar esconder loading inicial
                forceHideLoading();

                console.log('笨 Sistema de grid inicializado com sucesso');
            }

            // ===================================================================
            // AUTO-INICIALIZAﾃﾃグ
            // ===================================================================

            // Inicializar quando DOM estiver pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeGrid);
            } else {
                initializeGrid();
            }

            // Re-inicializar apﾃｳs AJAX
            document.addEventListener('gridUpdated', initializeGridEvents);

            // Exposer funﾃｧﾃｵes globais para debug
            window.gridUtils = {
                showLoading,
                forceHideLoading,
                aplicarFiltros,
                changePage,
                updateUrl,
                limparFiltros,
                sortColumn,
                debugGrid,
                initializeGridEvents
            };
        });

        // ===================================================================
        // FUNﾃﾃ髭S ESPECﾃ孝ICAS PARA DIFERENTES CONTROLADORES
        // ===================================================================

        // Nova venda (Clientes)
        window.novaVenda = function(clienteId) {
            if (clienteId) {
                window.location.href = `/Venda/Create?clienteId=${clienteId}`;
            } else {
                window.location.href = '/Venda/Create';
            }
        };

        // Nova avaliaﾃｧﾃ｣o (Clientes)
        window.novaAvaliacao = function(clienteId) {
            if (clienteId) {
                window.location.href = `/Avaliacao/Create?clienteId=${clienteId}`;
            } else {
                window.location.href = '/Avaliacao/Create';
            }
        };

        // Vender veﾃｭculo (Veﾃｭculos)
        window.venderVeiculo = function(idVeiculo) {
            if (idVeiculo) {
                window.location.href = `/Venda/Create?idVeiculo=${idVeiculo}`;
            }
        };

        // ===================================================================
        // OTIMIZAﾃﾃ髭S DE PERFORMANCE
        // ===================================================================

        // Debounce helper
        function debounce(func, wait, immediate) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }

        // Throttle helper
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // ===================================================================
        // OBSERVADOR DE INTERSECﾃﾃグ PARA LAZY LOADING
        // ===================================================================
        function setupIntersectionObserver() {
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animate-in');
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '50px'
                });

                // Observar cards e elementos da grid
                document.querySelectorAll('.card-modern, .grid-row').forEach(el => {
                    observer.observe(el);
                });
            }
        }

        // Inicializar observer apﾃｳs carregamento
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(setupIntersectionObserver, 500);
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

<style>
    .grid-1 {
        grid-template-columns: 1fr !important;
    }

    .grid-2 {
        grid-template-columns: 1fr 1fr !important;
    }

    .grid-3 {
        grid-template-columns: 1fr 1fr 1fr !important;
    }

    .grid-4 {
        grid-template-columns: 1fr 1fr 1fr 1fr !important;
    }

    .grid-5 {
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr !important;
    }

    .grid-6 {
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr !important;
    }

    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

        .form-section h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
        }

    .btn-action {
        transition: all 0.3s ease;
    }

        .btn-action:hover {
            transform: translateY(-1px);
        }
</style>